image: gradle:6.7.1 

stages:
  - build
  - test
  - run
  #- deploy

variables:
  MYSQL_DATABASE: e4l
  MYSQL_USER: root
  MYSQL_PASSWORD: 12345678
  MYSQL_ROOT_PASSWORD: 12345678
  GRADLE_USER_HOME: "./lu.uni.e4l.platform.api.dev/.gradle"
  BACKEND_DIR: "lu.uni.e4l.platform.api.dev"
  FRONTEND_DIR: "lu.uni.e4l.platform.frontend.dev"

# Cache dependencies to speed up builds
cache:
  paths:
    - lu.uni.e4l.platform.api.dev/.gradle/
    - lu.uni.e4l.platform.frontend.dev/node_modules/

services:
  - mysql:8.0.21

# Build the backend application
build_backend:
  stage: build
  script:
    - cd $BACKEND_DIR
    - ./gradlew clean build
  artifacts:
    paths:
      - $BACKEND_DIR/build/libs/

# Build the frontend application
build_frontend:
  stage: build
  image: node:15.14
  script:
    - cd $FRONTEND_DIR
    - npm install
  artifacts:
    paths:
      - $FRONTEND_DIR/build/

# Test the backend application
test_backend:
  stage: test
  script:
    - cd $BACKEND_DIR
    - ./gradlew test
  #artifacts:
  #  when: always
  #  reports:
  #    junit:
  #      - $BACKEND_DIR/build/test-results/test/TEST-*.xml
  #  paths:
  #    - $BACKEND_DIR/build/reports/tests/test/

# Test the frontend application
test_frontend:
  stage: test
  image: node:15.14
  script:
    - cd $FRONTEND_DIR
    - npm test
  #artifacts:
  #  when: always
  #  reports:
  #    junit:
  #      - $FRONTEND_DIR/test-results/test/TEST-*.xml
  #  paths:
  #    - $FRONTEND_DIR/test-results/

# Run the backend application
run_backend:
  stage: run
  script:
    - cd $BACKEND_DIR
    - ./gradlew bootRun
    - sleep 60

# Run the frontend application
run_frontend:
  stage: run
  image: node:15.14
  script:
    - cd $FRONTEND_DIR
    - npm start